/*! For license information please see bundle.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.FileUploader=t():e.FileUploader=t()}(this,()=>{return e={69(e,t,n){var r;function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,u=[],s=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=i.call(n)).done)&&(u.push(r.value),u.length!==t);s=!0);}catch(e){c=!0,o=e}finally{try{if(!s&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return u}}(e,t)||h(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e){if(null!=e){var t=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],n=0;if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}throw new TypeError(o(e)+" is not iterable")}function u(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var u=r&&r.prototype instanceof c?r:c,l=Object.create(u.prototype);return s(l,"_invoke",function(n,r,o){var i,u,s,c=0,l=o||[],f=!1,h={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return i=t,u=0,s=e,h.n=n,a}};function p(n,r){for(u=n,s=r,t=0;!f&&c&&!o&&t<l.length;t++){var o,i=l[t],p=h.p,d=i[2];n>3?(o=d===r)&&(s=i[(u=i[4])?5:(u=3,3)],i[4]=i[5]=e):i[0]<=p&&((o=n<2&&p<i[1])?(u=0,h.v=r,h.n=i[1]):p<d&&(o=n<3||i[0]>r||r>d)&&(i[4]=n,i[5]=r,h.n=d,u=0))}if(o||n>1)return a;throw f=!0,r}return function(o,l,d){if(c>1)throw TypeError("Generator is already running");for(f&&1===l&&p(l,d),u=l,s=d;(t=u<2?e:s)||!f;){i||(u?u<3?(u>1&&(h.n=-1),p(u,s)):h.n=s:h.v=s);try{if(c=2,i){if(u||(o="next"),t=i[o]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,u<2&&(u=0)}else 1===u&&(t=i.return)&&t.call(i),u<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),u=1);i=e}else if((t=(f=h.n<0)?s:n.call(r,h))!==a)break}catch(t){i=e,u=1,s=t}finally{c=1}}return{value:t,done:f}}}(n,o,i),!0),l}var a={};function c(){}function l(){}function f(){}t=Object.getPrototypeOf;var h=[][r]?t(t([][r]())):(s(t={},r,function(){return this}),t),p=f.prototype=c.prototype=Object.create(h);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,s(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=f,s(p,"constructor",f),s(f,"constructor",l),l.displayName="GeneratorFunction",s(f,o,"GeneratorFunction"),s(p),s(p,o,"Generator"),s(p,r,function(){return this}),s(p,"toString",function(){return"[object Generator]"}),(u=function(){return{w:i,m:d}})()}function s(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}s=function(e,t,n,r){function i(t,n){s(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},s(e,t,n,r)}function c(e,t,n,r,o,i,a){try{var u=e[i](a),s=u.value}catch(e){return void n(e)}u.done?t(s):Promise.resolve(s).then(r,o)}function l(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){c(i,r,o,a,u,"next",e)}function u(e){c(i,r,o,a,u,"throw",e)}a(void 0)})}}function f(e){return function(e){if(Array.isArray(e))return p(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||h(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){if(e){if("string"==typeof e)return p(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(e,t):void 0}}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,y(r.key),r)}}function y(e){var t=function(e){if("object"!=o(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==o(t)?t:t+""}var m=function(){return e=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.checkEndpoint=t.checkEndpoint,this.chunkEndpoint=t.chunkEndpoint,this.mergeEndpoint=t.mergeEndpoint,!this.checkEndpoint||!this.chunkEndpoint||!this.mergeEndpoint)throw new Error("All API endpoints (checkEndpoint, chunkEndpoint, mergeEndpoint) must be provided / 所有API端点（checkEndpoint、chunkEndpoint、mergeEndpoint）都必须提供");this.chunkSize=t.chunkSize||2097152,this.concurrentFiles=t.concurrentFiles||3,this.concurrentChunks=t.concurrentChunks||3,this.maxRetries=t.maxRetries||3,this.uploadQueue=[],this.uploadingCount=0,this.files=[],this.abortControllers=new Map},t=[{key:"addFiles",value:function(e){var t=this,n=Array.from(e).map(function(e){return{id:t.generateId(),file:e,status:"pending",progress:0,name:e.name,size:e.size,uploadedChunks:[],totalChunks:Math.ceil(e.size/t.chunkSize)}});return this.files=[].concat(f(this.files),f(n)),this.uploadQueue=[].concat(f(this.uploadQueue),f(n)),this.processQueue(),n}},{key:"cancelUpload",value:function(e){var t=this.files.find(function(t){return t.id===e});if(t){if("pending"===t.status)return this.uploadQueue=this.uploadQueue.filter(function(t){return t.id!==e}),t.status="cancelled",void this.updateFileStatus(t);if("checking"===t.status||"uploading"===t.status||"merging"===t.status){var n=this.abortControllers.get(e);return n&&(n.abort(),this.abortControllers.delete(e)),t.status="cancelled",void this.updateFileStatus(t)}}else console.warn("File with ID ".concat(e," not found"))}},{key:"processQueue",value:function(){for(var e=this;this.uploadQueue.length>0&&this.uploadingCount<this.concurrentFiles;){var t=this.uploadQueue.shift();t&&(this.uploadingCount++,this.processFile(t).finally(function(){e.uploadingCount--,e.processQueue()}))}}},{key:"processFile",value:(y=l(u().m(function e(t){var n,r,o,i,a;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=new AbortController,this.abortControllers.set(t.id,n),e.p=1,t.status="checking",this.updateFileStatus(t),e.n=2,this.calculateMD5(t.file);case 2:return r=e.v,t.md5=r,e.n=3,this.checkFile(t.md5,t.file.name,n.signal);case 3:if(!(o=e.v).exists){e.n=4;break}return t.status="success",t.progress=100,this.updateFileStatus(t),this.abortControllers.delete(t.id),e.a(2);case 4:if(i=Array.from({length:t.totalChunks},function(e,t){return t}).filter(function(e){return!o.uploadedChunks.includes(e)}),t.uploadedChunks=o.uploadedChunks,0!==i.length){e.n=6;break}return e.n=5,this.mergeFile(t.md5,t.file.name,t.totalChunks,n.signal);case 5:return t.status="success",t.progress=100,this.updateFileStatus(t),this.abortControllers.delete(t.id),e.a(2);case 6:return t.status="uploading",this.updateFileStatus(t),e.n=7,this.uploadChunksWithConcurrency(t,i,n.signal);case 7:return t.status="merging",this.updateFileStatus(t),e.n=8,this.mergeFile(t.md5,t.file.name,t.totalChunks,n.signal);case 8:t.status="success",t.progress=100,this.updateFileStatus(t),this.abortControllers.delete(t.id),e.n=10;break;case 9:e.p=9,"AbortError"===(a=e.v).name?(t.status="cancelled",this.updateFileStatus(t)):(t.status="error",t.error=a.message,this.updateFileStatus(t),console.error("Upload error:",a)),this.abortControllers.delete(t.id);case 10:return e.a(2)}},e,this,[[1,9]])})),function(e){return y.apply(this,arguments)})},{key:"uploadChunksWithConcurrency",value:(p=l(u().m(function e(t,n,r){var o,i,a,s=this;return u().w(function(e){for(;;)switch(e.n){case 0:return o=0,i=function(){var e=l(u().m(function e(n){var o,i,a,c,l;return u().w(function(e){for(;;)switch(e.n){case 0:if(!r.aborted){e.n=1;break}throw new DOMException("Aborted","AbortError");case 1:return o=n*s.chunkSize,i=Math.min(o+s.chunkSize,t.file.size),a=t.file.slice(o,i),(c=new FormData).append("file",a),c.append("md5",t.md5),c.append("chunkIndex",n.toString()),c.append("totalChunks",t.totalChunks.toString()),e.n=2,s.uploadWithRetry(function(e){return fetch(s.chunkEndpoint,{method:"POST",body:c,signal:e})},s.maxRetries,r);case 2:t.uploadedChunks.push(n),l=Math.round(t.uploadedChunks.length/t.totalChunks*100),t.progress=l,s.updateFileStatus(t);case 3:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}(),a=Array.from({length:this.concurrentChunks},l(u().m(function e(){var t;return u().w(function(e){for(;;)switch(e.n){case 0:if(!(o<n.length)||r.aborted){e.n=2;break}return t=n[o],o++,e.n=1,i(t);case 1:e.n=0;break;case 2:return e.a(2)}},e)}))),e.n=1,Promise.all(a);case 1:if(!r.aborted){e.n=2;break}throw new DOMException("Aborted","AbortError");case 2:return e.a(2)}},e,this)})),function(e,t,n){return p.apply(this,arguments)})},{key:"checkFile",value:(c=l(u().m(function e(t,n,r){var o;return u().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,fetch(this.checkEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({md5:t,filename:n}),signal:r});case 1:if((o=e.v).ok){e.n=2;break}throw new Error("HTTP error! status: ".concat(o.status));case 2:return e.a(2,o.json())}},e,this)})),function(e,t,n){return c.apply(this,arguments)})},{key:"mergeFile",value:(s=l(u().m(function e(t,n,r,o){var i;return u().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,fetch(this.mergeEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({md5:t,filename:n,totalChunks:r}),signal:o});case 1:if((i=e.v).ok){e.n=2;break}throw new Error("HTTP error! status: ".concat(i.status));case 2:return e.a(2,i.json())}},e,this)})),function(e,t,n,r){return s.apply(this,arguments)})},{key:"uploadWithRetry",value:(o=l(u().m(function e(t,n,r){var o,i,s,c;return u().w(function(e){for(;;)switch(e.n){case 0:i=u().m(function e(){var i,a,s;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!r.aborted){e.n=1;break}throw new DOMException("Aborted","AbortError");case 1:return e.p=1,e.n=2,t(r);case 2:if((i=e.v).ok){e.n=3;break}throw new Error("HTTP error! status: ".concat(i.status));case 3:return e.a(2,{v:i});case 4:if(e.p=4,"AbortError"!==(s=e.v).name){e.n=5;break}throw s;case 5:if(o=s,!(c<n)){e.n=6;break}return a=Math.min(1e3*Math.pow(2,c),1e4),e.n=6,new Promise(function(e){return setTimeout(e,a)});case 6:return e.a(2)}},e,null,[[1,4]])}),c=0;case 1:if(!(c<=n)){e.n=4;break}return e.d(a(i()),2);case 2:if(!(s=e.v)){e.n=3;break}return e.a(2,s.v);case 3:c++,e.n=1;break;case 4:throw o;case 5:return e.a(2)}},e)})),function(e,t,n){return o.apply(this,arguments)})},{key:"calculateMD5",value:(r=l(u().m(function e(t){var n=this;return u().w(function(e){for(;;)switch(e.n){case 0:if("undefined"==typeof Worker){e.n=1;break}return e.a(2,new Promise(function(e,r){try{var o=new Blob(["\n            self.onmessage = function(event) {\n              const { file, chunkSize = 2 * 1024 * 1024 } = event.data;\n              \n              try {\n                // Dynamically import SparkMD5 / 动态导入SparkMD5\n                importScripts('https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js');\n                \n                const spark = new SparkMD5.ArrayBuffer();\n                let currentChunk = 0;\n                const totalChunks = Math.ceil(file.size / chunkSize);\n\n                function loadNextChunk() {\n                  const start = currentChunk * chunkSize;\n                  const end = Math.min(start + chunkSize, file.size);\n                  const chunk = file.slice(start, end);\n                  \n                  const reader = new FileReader();\n                  reader.onload = function(e) {\n                    spark.append(e.target.result);\n                    currentChunk++;\n                    \n                    // Send progress update / 发送进度更新\n                    const progress = Math.round((currentChunk / totalChunks) * 100);\n                    self.postMessage({ progress, type: 'progress' });\n                    \n                    if (currentChunk < totalChunks) {\n                      loadNextChunk();\n                    } else {\n                      const md5 = spark.end();\n                      self.postMessage({ md5, success: true });\n                    }\n                  };\n                  \n                  reader.onerror = function(err) {\n                    self.postMessage({ error: 'Failed to read file chunk: ' + err.message, success: false });\n                  };\n                  \n                  reader.readAsArrayBuffer(chunk);\n                }\n                \n                loadNextChunk();\n              } catch (error) {\n                self.postMessage({ error: 'Worker error: ' + error.message, success: false });\n              }\n            };\n          "],{type:"application/javascript"}),i=URL.createObjectURL(o),a=new Worker(i);a.postMessage({file:t,chunkSize:n.chunkSize}),a.onmessage=function(t){var n=t.data;"progress"===n.type?console.log("MD5 calculation progress: "+n.progress+"%"):n.success?(URL.revokeObjectURL(i),e(n.md5),a.terminate()):(URL.revokeObjectURL(i),r(new Error(n.error)),a.terminate())},a.onerror=function(e){URL.revokeObjectURL(i),r(new Error("Worker error: "+e.message)),a.terminate()}}catch(o){console.warn("Failed to initialize Web Worker, falling back to main thread calculation / 无法初始化Web Worker，回退到主线程计算"),n.calculateMD5Fallback(t).then(e).catch(r)}}));case 1:return console.warn("Web Workers not supported, falling back to main thread calculation / 不支持Web Workers，回退到主线程计算"),e.a(2,this.calculateMD5Fallback(t));case 2:return e.a(2)}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"calculateMD5Fallback",value:(n=l(u().m(function e(t){return u().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){setTimeout(function(){e("md5-"+Date.now()+"-"+t.name)},300)}))},e)})),function(e){return n.apply(this,arguments)})},{key:"generateId",value:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}},{key:"updateFileStatus",value:function(e){console.log("File ".concat(e.name,": ").concat(e.status," (").concat(e.progress,"%)"))}},{key:"getFiles",value:function(){return this.files}},{key:"destroy",value:function(){var e,t=function(e){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=h(e))){t&&(e=t);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){a=!0,o=e},f:function(){try{i||null==t.return||t.return()}finally{if(a)throw o}}}}(this.abortControllers.entries());try{for(t.s();!(e=t.n()).done;){var n=i(e.value,2);n[0],n[1].abort()}}catch(e){t.e(e)}finally{t.f()}this.abortControllers.clear(),this.uploadQueue=[],this.files=[]}}],t&&d(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o,s,c,p,y}();e.exports?e.exports=m:void 0===(r=function(){return m}.call(t,n,t,e))||(e.exports=r)}},t={},function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}(69);var e,t});
//# sourceMappingURL=bundle.js.map